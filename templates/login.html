<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login</title>
    <style>
        .error { color: red; font-size: 0.9em; margin-top: 4px; }
        input { display: block; margin-bottom: 10px; padding: 6px; width: 200px; }
        button { padding: 6px 12px; }
    </style>
</head>
<body>
    <h2>Login</h2>

    <!-- Username -->
    <label for="username">Username</label>
    <input type="text" id="username" placeholder="Enter your username">
    <div id="username-error" class="error"></div>

    <!-- Password -->
    <label for="password">Password</label>
    <input type="password" id="password" placeholder="Enter your password">
    <div id="password-error" class="error"></div>

    <!-- General error -->
    <div id="general-error" class="error"></div>

    <!-- Login button -->
    <button id="login-btn">Login</button>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script>
        
        const csrftoken = Cookies.get('csrftoken');
        {#console.log(csrftoken)#}

        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const usernameError = document.getElementById('username-error');
        const passwordError = document.getElementById('password-error');
        const generalError = document.getElementById('general-error');
        const loginBtn = document.getElementById('login-btn');
        
        usernameInput.addEventListener('input', () => { usernameError.innerText = ''; generalError.innerText = ''; });
        passwordInput.addEventListener('input', () => { passwordError.innerText = ''; generalError.innerText = ''; });

        async function login() {
            usernameError.innerText = '';
            passwordError.innerText = '';
            generalError.innerText = '';

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            try {
                const response = await fetch('/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.status === 'fail') {
                    const errors = data.errors || {};
                    if (errors.username) usernameError.innerText = errors.username;
                    if (errors.password) passwordError.innerText = errors.password;
                    if (errors.general) generalError.innerText = errors.general;
                } else if (data.status === 'success') {
                    window.location.href = data.redirect;
                }
            } catch (err) {
                generalError.innerText = 'Network error, please try again later.';
            }
        }

        loginBtn.addEventListener('click', login);
        
        [usernameInput, passwordInput].forEach(input => {
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });
        });
    </script>
</body>
</html>
